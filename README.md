# Установка

## Процесс установки приведён на примере операционной системы [Ubuntu 18.10](http://releases.ubuntu.com/18.10/)

Перед запуском приложения необходимо установить следущие зависимости:
  - RVM
    ```
    $ gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
    $ \curl -sSL https://get.rvm.io | bash -s stable --rails
    $ source /home/$USER/.rvm/scripts/rvm    # для возможонсти ипользования команд bundle, gem, ruby в текущей сессии терминала
    ```
    Больше информации [по ссылке](https://rvm.io/rvm/install).

    > **Внимание:** Для использования команд **bundle**, **gem**, **ruby** в терминале при запуске интерактивной оболочки, например **bash**, нужно добавить в файл **.bashrc** следующую строку "`source /home/$USER/.rvm/scripts/rvm`" - путь куда установлен **RVM**

  - Ruby
    ```
    $ rvm install 2.5.1
    $ rvm use 2.5.1
    ```
  - Rails
    ```
    $ apt install ruby-railties
    ```
  - NodeJs
    ```
    $ apt install nodejs
    ```
    Больше информации [по ссылке](https://nodejs.org/en/download/).
  - Redis
    ```
    $ apt install redis-server
    ```
    Больше информации [по ссылке](https://redis.io/topics/quickstart).
  
# Установка пакетов
> Перед выполнением команды нужно перейти в корень проекта
```
$ bundle
```
# Подготовка базы данных

Нужно использовать rake tast в /lib/tasks/run 
который выполняет команду  **sh "rake db:drop db:create db:migrate db:seed"**

```
$ rails prepare
```

# Запуск тестов
```
$ rails test
```

# Запуск приложения
Перед запуском необходимо включить сервис redis
```
$ service redis-server start
```
Запустить sidekiq
```
$ bundle exec sidekiq
```
Запустить приложение
```
$ rails s
```

# Описание

## Регистрация
> Реализовано в функции **signup** users_controller.rb

После успешной регистрации высылается письмо на почту пользователю, в данном случае просто открывается новая вкладка для предпросмотра с помощью библиотеки **letter_opener**, если sidekiq и redis запущены. Отправленные письма **letter_opener** сохраняются в /tmp/letter_opener/ .

## Вход в систему
> Реализовано в функции **login** users_controller.rb

В данном проекте используется 3 уровня доступа
 - авторизованный
 - неавторизованный
 - администратор

Авторизованный пользователь представлен классом User, который имеет функцию **logged?** по умолчанию установленную в true, то есть пользователь находится в системе. При входе в систему генерируется cookie автоматического входа в систему, для возможности пользователя возобновить сессию без повторного ввода пароля и токен текущей сессии, действительный до момента выхода пользователя из системы. Для редактирования данных о пользователе можно нажать на логин указанный в правому углу на домашней странице, в данном случае имеется возомжность редактирования только имени пользователя. Перед каждым действием пользователя вызывается метод **find_current_user** в **application_controller.rb** который определяет статус пользователя.

Неавторизованный пользователь представлен классом AnonymousUser который наследует класс User и переопределяет функцию **logged?** всегда false. Любой неавторизованный пользователь зашедший на сайт всегда является AnonymousUser, который устанавливается в функции **find_current_user application_controller.rb** и не имеет доступа к секциям авторизованного пользователя.

Администратор имеет возможность редактировать/создавать/удалять пользователей, книги, авторов и жанры. Аутентификация администратора осуществлена с помощью фильтра **before_action** которая вызывает функцию **require_admin** перед каждым действием требующим администратора в **application_controller.rb** 

## Восстановление пароля
> Реализовано в функции **lost_password** и **password_recovery** users_controller.rb

**lost_password** отвечает за обработку почты в форме и отправку письма на почту.

**password_recovery** это функция которая обрабатывает форму для изменения пароля, проверяющая валидность одноразового токена для смены пароля и находит пользователя которому принадлежит данный токен.

При вводе почтового ящика существующего пользователя ему отправляется письмо со ссылкой доступа для сброса пароля. Одноразовый токен генерируется в момент отправки формы и действителен в течении 1 дня, описание в модели **token.rb**

Для удаления недействительных токенов из базы данных можно использовать rake task
```
$ rails tokens:remove_expired
```
который находится в */lib/tasks/token.rake*

## Секция администратора
> Реализовано в контроллерах /admin/ { users_controller, authors_controller, genres_controller }.rb

Для разделения маршрутов пользователя и администратора используется пространство имён **admin** в **routes.rb**, таким образом пользователь не может получить доступ к редактированию чужого профиля, авторов, жанров или книг. При этом при попытке пользователя перейти на маршрут на котором он быть не должен рендерится страница со статусом 403 доступ запрещен. При попытке любого пользователя перейти на несуществующую страницу рендится страница со статусом 404 не найдена. В **routes.rb** все несуществеющие маршруты по умолчанию перенапрявляются на 404 **get '*unmatched_route', to: 'application#render_404'**




## Поиск
> Реализовано в модели book.rb

Поиск осуществлён в приватной функции **self.search**, которая выдаёт все книги из базы данных если запрос пуст и фильтрует по категориям если запрос содержит ключевые слова. В данном случае фильтр представлен полем для ввода без выбора категории(жанр,автор), вместо этого идёт поиск по всем полям одновременно, включая имя и фамилию автора указанную в одном запросе. 
